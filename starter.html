<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WAV Decoder – Starter Demo</title>
  <link rel="icon" href="public/favicon/favicon.svg" type="image/svg+xml" />
  <style>
      :root {
          --bg: #f8fafc;
          --fg: #0f172a;
          --border: #cbd5e1;
          --accent: #2563eb;
      }

      @media (prefers-color-scheme: dark) {
          :root {
              --bg: #0f172a;
              --fg: #f8fafc;
              --border: #334155;
              --accent: #3b82f6;
          }
      }

      body {
          font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
          background: var(--bg);
          color: var(--fg);
          line-height: 1.6;
          margin: 0;
          padding: 2rem 1rem;
          display: flex;
          flex-direction: column;
          align-items: center;
      }

      h1 {
          font-size: 1.5rem;
          margin-bottom: 1.5rem;
          text-align: center;
      }

      .drop-zone {
          width: min(420px, 90vw);
          padding: 3rem 1.5rem;
          border: 2px dashed var(--border);
          border-radius: 8px;
          text-align: center;
          cursor: pointer;
          transition: all 150ms ease;
      }

      .drop-zone:hover, .drop-zone.dragover {
          background: color-mix(in srgb, var(--accent) 7%, transparent);
          border-color: var(--accent);
      }

      .drop-zone[aria-disabled='true'] {
          opacity: 0.5;
          cursor: not-allowed;
      }

      #results {
          width: min(420px, 90vw);
          border: 1px solid var(--border);
          border-radius: 8px;
          padding: 1rem;
          margin-top: 1.25rem;
          font-size: 0.925rem;
      }

      #results ul {
          list-style: none;
          padding: 0;
          margin: 0;
          display: grid;
          gap: 0.5rem;

          li {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 0.5rem 0;
          }
      }

      #results li span {
          font-weight: 600;
      }

      button {
          margin-top: 1.5rem;
          padding: 0.65rem 1.25rem;
          font-size: 0.95rem;
          border: none;
          border-radius: 6px;
          color: var(--bg);
          background: var(--accent);
          cursor: pointer;
      }
  </style>
</head>
<body>
<h1>WAV Decoder — Starter Demo</h1>

<div id="uploadZone" class="drop-zone" role="button" tabindex="0">
  Drop a .wav file here<br />or click to select
</div>
<input id="fileInput" type="file" accept="audio/wav,.wav" hidden />

<section id="results" class="hidden">
  <ul>
    <li>Status: <span id="status">-</span></li>
    <li>Format: <span id="format">-</span></li>
    <li>Channels: <span id="channels">-</span></li>
    <li>Sample Rate: <span id="sampleRate">-</span></li>
    <li>Total Samples: <span id="samples">-</span></li>
  </ul>
</section>

<button id="resetBtn" hidden>Decode Another File</button>

<script type="module">
  import { WavDecoder, WavFormatTagNames } from './dist/index.js';

  const els = {
    drop: document.getElementById('uploadZone'),
    input: document.getElementById('fileInput'),
    results: document.getElementById('results'),
    status: document.getElementById('status'),
    format: document.getElementById('format'),
    channels: document.getElementById('channels'),
    sampleRate: document.getElementById('sampleRate'),
    samples: document.getElementById('samples'),
    reset: document.getElementById('resetBtn'),
  };

  async function handleFile(file) {
    resetUI();
    els.drop.setAttribute('aria-disabled', 'true');
    els.results.classList.remove('hidden');
    els.status.textContent = `Decoding "${file.name}"`;

    const decoder = new WavDecoder();
    let totalSamples = 0;

    try {
      for await (const chunk of file.stream()) {
        const decoded = decoder.decode(chunk);

        if (decoded.samplesDecoded > 0) {
          totalSamples += decoded.samplesDecoded;
        }

        updateUI(decoder.info, totalSamples);

        await new Promise(requestAnimationFrame);
      }

      const finalChunk = decoder.flush();
      totalSamples += finalChunk.samplesDecoded;

      els.status.textContent = 'Done';
      updateUI(decoder.info, totalSamples);

    } catch (error) {
      els.status.textContent = `Error: ${error.message}`;
      console.error(error);
    } finally {
      els.reset.hidden = false;
    }
  }

  function updateUI(info, currentTotalSamples) {
    if (info.format.formatTag) {
      els.format.textContent = WavFormatTagNames[info.format.formatTag] || `Unknown (${info.format.formatTag})`;
      els.channels.textContent = info.format.channels;
      els.sampleRate.textContent = `${info.format.sampleRate.toLocaleString()} Hz`;
    }
    els.samples.textContent = currentTotalSamples.toLocaleString();
  }

  function resetUI() {
    els.results.classList.add('hidden');
    els.drop.removeAttribute('aria-disabled');
    els.reset.hidden = true;
    ['status', 'format', 'channels', 'sampleRate', 'samples'].forEach((id) => (els[id].textContent = '-'));
    els.drop.textContent = 'Drop a .wav file here\nor click to select';
  }

  function setupEventListeners() {
    els.drop.addEventListener('click', () => els.input.click());
    els.input.addEventListener('change', (e) => e.target.files?.[0] && handleFile(e.target.files[0]));
    els.reset.addEventListener('click', resetUI);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((evName) => {
      els.drop.addEventListener(evName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (evName === 'dragenter' || evName === 'dragover') {
          els.drop.classList.add('dragover');
        } else if (evName === 'drop') {
          const file = Array.from(e.dataTransfer.files).find((f) => f.name.endsWith('.wav'));
          if (file) handleFile(file);
          els.drop.classList.remove('dragover');
        } else {
          els.drop.classList.remove('dragover');
        }
      });
    });
  }

  setupEventListeners();
</script>
</body>
</html>
